---
layout: post
title: Cannot start docker after kernel upgrading
date: '2017-10-13T08:08:00.001-07:00'
author: Simple Pleasure
tags:
- english version
modified_time: '2017-10-19T10:03:36.716-07:00'
blogger_id: tag:blogger.com,1999:blog-1992588495677931791.post-4726814972331739405
blogger_orig_url: http://linuxmates.blogspot.com/2017/10/cannot-start-docker-after-kernel.html
---

<div dir="ltr" style="text-align: left;" trbidi="on">There is a problem with Linux kernel 3.16 (Debian Jessie) interacting with new versions of Docker (17.x). Sometimes a server running these versions of kernel and Docker Engine could stuck and don't answer on the users commands. The only way to solve this problem (server hanging) is rebooting the server.<br />To resolve this issue completely you should upgrade the kernel image from 3.16 to 4.X using jessie-backports.<br /><br />1. Add a backports repository to sources list:<br /><pre class="brush: js">sudo bash -c 'echo "deb http://httpredir.debian.org/debian jessie-backports main contrib non-free" &gt;&nbsp;&nbsp;/etc/apt/sources.list.d/backports.list'<br /><br /></pre>2. Update your cache<br /><pre class="brush: js">sudo apt-get update<br /><br /></pre>3. Find out a necessary versions of packages<br />Basically you need to install two packages - linux-image-4.x.x.bpo.x-{arch} and&nbsp;linux-image-amd64. You can check available versions of these packages using the commands:<br /><pre class="brush: js">apt-cache policy&nbsp;linux-image-amd64<br /><br />apt-cache search&nbsp;linux-image-4<br /><br /></pre>Sample output:<br /><pre class="brush: js">root@server:~# apt-cache policy linux-image-amd64<br /><br />linux-image-amd64:<br /><br />&nbsp; Installed: 3.16+63<br /><br />&nbsp; Candidate: 3.16+63<br /><br />&nbsp; Version table:<br /><br />&nbsp; 4.9+80~bpo8+1 800<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; 200 http://httpredir.debian.org/debian/ jessie-backports/main amd64 Packages<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; 100 /var/lib/dpkg/status<br /><br />&nbsp;*** 3.16+63 800<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; 500 http://ftp.us.debian.org/debian/ jessie/main amd64 Packages<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; 500 http://cdn.debian.net/debian/ jessie/main amd64 Packages<br /><br />root@silver-cta1.semrush.net:~# apt-cache search linux-image-4</pre>linux-headers-4.9.0-0.bpo.3-amd64 - Header files for Linux 4.9.0-0.bpo.3-amd64  linux-headers-4.9.0-0.bpo.3-rt-amd64 - Header files for Linux 4.9.0-0.bpo.3-rt-amd64  linux-image-4.9.0-0.bpo.3-amd64 - Linux 4.9 for 64-bit PCs  ---------------------------output omitted-------------------------------------  <br /><div><br /></div><div>4. Install kernel packages:</div><div><pre class="brush: js">sudo apt-get install linux-image-amd64=4.9+80~bpo8+1 linux-image-4.9.0-0.bpo.3-amd64</pre></div><div><br /></div><div><br /></div><div>5. Now you need to reboot the server.</div><div><br /></div><div><br /></div>After that check currently version of the kernel using dpkg or uname -a. If upgrade was successful you will see correct new package versions. Now start docker process<br /><pre class="brush: js">root@server:~# systemctl start docker<br /><br />Job for docker.service failed. See 'systemctl status httpd.service' and 'journalctl -xn' for details.<br /></pre><br />Oops, what's going on?<br /><pre class="brush: js">journalctl -u docker<br /><br />Oct 13 08:06:39 silver-cta3.semrush.net systemd[1]: docker.service start request repeated too quickly, refusing to start.<br /><br />Oct 13 08:06:39 silver-cta3.semrush.net systemd[1]: Failed to start Docker Application Container Engine.<br /><br />Oct 13 08:06:39 silver-cta3.semrush.net systemd[1]: Unit docker.service entered failed state.<br /><br />Oct 13 08:13:46 silver-cta3.semrush.net systemd[1]: Starting Docker Application Container Engine...<br /><br />Oct 13 08:13:46 silver-cta3.semrush.net docker[26423]: Command "daemon" is deprecated, and will be removed in Docker 17.12. Please run `dockerd` directly.<br /><br />Oct 13 08:13:46 silver-cta3.semrush.net docker[26423]: time="2017-10-13T08:13:46.065379664-04:00" level=info msg="libcontainerd: new containerd process, pid: 26438"<br /><br />Oct 13 08:13:47 silver-cta3.semrush.net docker[26423]: time="2017-10-13T08:13:47.066742860-04:00" level=warning msg="failed to rename /var/lib/docker/tmp for background deletion: %!s(&lt;nil&gt;). Deleting synchronously"<br /><br />Oct 13 08:13:47 silver-cta3.semrush.net docker[26423]: time="2017-10-13T08:13:47.068803075-04:00" level=error msg="[graphdriver] prior storage driver aufs failed: driver not supported"<br /><br />Oct 13 08:13:47 silver-cta3.semrush.net docker[26423]: Error starting daemon: error initializing graphdriver: driver not supported<br /><br />Oct 13 08:13:47 silver-cta3.semrush.net systemd[1]: docker.service: main process exited, code=exited, status=1/FAILURE<br /><br /></pre><br />We see an error message: error msg="[graphdriver] prior storage driver aufs failed: driver not supported". Hm, let me check is aufs is supported file systems by the kernel?<br /><br /><pre class="brush: js">root@silver-cta1.semrush.net:~# docker info | grep "Storage Driver"<br /><br />Storage Driver: aufs<br /><br /></pre><br /><pre class="brush: js">root@silver-cta1.semrush.net:~# grep -E 'aufs|overlay' /proc/filesystems<br /><br />nodev<span style="white-space: pre;"> </span>overlay<br /><br /></pre><div><br /></div><div>The kernel doesn't support docker storage driver. Kernel 3.16 supports aufs, but 4.X does not, BUT it supports now overlayfs, which is used by Docker too.</div><div><br /></div><div>Next step can be dangerous for your existing images or containers. We are building docker images on deploy stage from base images downloaded from a docker hubs, so for us this operation is safe, because at any moment of rime we can build new images and create new containers. But I should note that you don't miss your files.</div><div>Execute the following command:</div><div><pre class="brush: js">mv /var/lib/docker/aufs/ /var/lib/docker/aufs.old</pre></div><div><br /></div><div>And start the docker service. Service should start without problems. Now docker engine will use overlay2 as its default storage driver.</div></div>